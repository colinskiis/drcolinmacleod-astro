---
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
import Search from '../components/Search.astro';
import BookingButton from '../components/BookingButton.astro';
import MedicalDisclaimer from '../components/MedicalDisclaimer.astro';
import { Calendar, Menu, X, ChevronRight } from '@lucide/astro';

export interface Props {
  title: string;
  description: string;
  focusKeyword?: string;
  image?: string;
  articleData?: {
    publishDate?: string;
    modifiedDate?: string;
    author?: string;
    tags?: string[];
  };
}

const { title, description, focusKeyword, image, articleData } = Astro.props;
const fullTitle = title === 'Home' ? 'Dr. Colin MacLeod ND - Halifax Naturopathic Doctor' : `${title} | Dr. Colin MacLeod ND`;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const ogImage = image || '/images/reference/home-background.webp';

// Schema definitions (pre-stringified for proper output)
const medicalBusinessSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "MedicalBusiness",
  "name": "Dr. Colin MacLeod ND",
  "description": "Halifax Naturopathic Doctor providing comprehensive natural healthcare solutions including IV therapy, prolotherapy, acupuncture and clinical nutrition.",
  "url": "https://drcolinmacleod.com",
  "logo": "https://drcolinmacleod.com/favicon.svg",
  "image": "https://drcolinmacleod.com/images/general/colin-hero.webp",
  "priceRange": "$$",
  "medicalSpecialty": "Naturopathic Medicine",
  "contactPoint": {
    "@type": "ContactPoint",
    "contactType": "appointment booking",
    "url": "https://macleodnaturopathic.janeapp.com/",
    "telephone": "+1-902-406-4424"
  },
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "6140 Young Street",
    "addressLocality": "Halifax",
    "addressRegion": "Nova Scotia",
    "postalCode": "B3K 0G2",
    "addressCountry": "CA"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": "44.6488",
    "longitude": "-63.6046"
  },
  "areaServed": {
    "@type": "City",
    "name": "Halifax",
    "containedInPlace": {
      "@type": "State",
      "name": "Nova Scotia"
    }
  },
  "openingHoursSpecification": [
    {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday", "Wednesday", "Thursday", "Friday"],
      "opens": "07:30",
      "closes": "15:30"
    }
  ],
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Naturopathic Services",
    "itemListElement": [
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "IV Therapy"}},
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "Prolotherapy"}},
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "Acupuncture"}},
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "Clinical Nutrition"}},
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "Herbal Medicine"}},
      {"@type": "Offer", "itemOffered": {"@type": "Service", "name": "Chelation Therapy"}}
    ]
  },
  "sameAs": [
    "https://macleodnaturopathic.janeapp.com/"
  ]
});

const personSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Dr. Colin MacLeod",
  "givenName": "Colin",
  "familyName": "MacLeod",
  "honorificPrefix": "Dr.",
  "honorificSuffix": "ND",
  "jobTitle": "Naturopathic Doctor",
  "description": "Naturopathic Doctor in Halifax, Nova Scotia specializing in IV therapy, prolotherapy, sports medicine, and herbal medicine.",
  "url": "https://drcolinmacleod.com/about",
  "image": "https://drcolinmacleod.com/images/general/colin-hero.webp",
  "alumniOf": {
    "@type": "CollegeOrUniversity",
    "name": "Canadian College of Naturopathic Medicine",
    "alternateName": "CCNM",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Toronto",
      "addressRegion": "Ontario",
      "addressCountry": "CA"
    }
  },
  "hasCredential": {
    "@type": "EducationalOccupationalCredential",
    "credentialCategory": "degree",
    "name": "Doctor of Naturopathy (ND)"
  },
  "knowsAbout": [
    "Naturopathic Medicine",
    "IV Therapy",
    "Prolotherapy",
    "Sports Medicine",
    "Herbal Medicine",
    "Clinical Nutrition",
    "Acupuncture",
    "Chelation Therapy"
  ],
  "worksFor": {
    "@type": "MedicalBusiness",
    "name": "Dr. Colin MacLeod ND",
    "url": "https://drcolinmacleod.com",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "6140 Young Street",
      "addressLocality": "Halifax",
      "addressRegion": "Nova Scotia",
      "postalCode": "B3K 0G2",
      "addressCountry": "CA"
    }
  },
  "workLocation": {
    "@type": "Place",
    "name": "Optimal Wellbeing Clinic",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "6140 Young Street",
      "addressLocality": "Halifax",
      "addressRegion": "Nova Scotia",
      "postalCode": "B3K 0G2",
      "addressCountry": "CA"
    }
  }
});

const articleSchema = articleData ? JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "name": articleData.author || "Dr. Colin MacLeod ND"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dr. Colin MacLeod ND",
    "logo": {
      "@type": "ImageObject",
      "url": "https://drcolinmacleod.com/favicon.svg"
    }
  },
  "datePublished": articleData.publishDate,
  "dateModified": articleData.modifiedDate || articleData.publishDate,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalUrl.toString()
  },
  "image": new URL(ogImage, Astro.site).toString()
}) : null;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{fullTitle}</title>

    <!-- Resource hints for faster loading -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googletagmanager.com" />

    <!-- Google Analytics -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-HWHX5T8PEG"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-HWHX5T8PEG');

      // Track page views on client-side navigation (View Transitions)
      document.addEventListener('astro:page-load', function() {
        if (typeof gtag !== 'undefined') {
          gtag('config', 'G-HWHX5T8PEG', { page_path: window.location.pathname });
        }
      });
    </script>

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- SEO Meta Tags -->
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={articleData ? "article" : "website"} />
    <meta property="og:site_name" content="Dr. Colin MacLeod ND" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={new URL(ogImage, Astro.site)} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="en_CA" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, Astro.site)} />
    
    {focusKeyword && <meta name="keywords" content={focusKeyword} />}
    <meta name="author" content="Dr. Colin MacLeod ND" />
    <meta name="robots" content="index, follow" />
    
    <!-- Structured Data: MedicalBusiness -->
    <script type="application/ld+json" set:html={medicalBusinessSchema} />

    <!-- Structured Data: Person (Practitioner) -->
    <script type="application/ld+json" set:html={personSchema} />

    {articleSchema && (
      <script type="application/ld+json" set:html={articleSchema} />
    )}
    <!-- Fonts loaded via global.css (Manrope, Playfair Display) -->
    <ClientRouter />
  </head>
  <body class="font-sans antialiased bg-[#f7f7f5] text-[#0f1b1a]">
    <!-- Skip to main content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:bg-white focus:text-emerald-900 focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:font-semibold"
    >
      Skip to main content
    </a>

    <!-- Header Navigation -->
    <header id="site-header" class="fixed inset-x-0 top-0 z-40 bg-emerald-950 shadow-lg">
      <div class="section-shell">
        <nav class="flex items-center justify-between py-4 gap-3 sm:gap-6">
          <!-- Logo with botanical mark -->
          <a href="/" class="flex items-center gap-3 text-white flex-shrink-0 group">
            <!-- CSS Logo Mark - Leaf icon -->
            <div class="relative w-10 h-10 flex items-center justify-center flex-shrink-0">
              <div class="absolute inset-0 rounded-full border-2 border-emerald-400/50 group-hover:border-emerald-300 transition-colors"></div>
              <svg class="w-5 h-5 text-emerald-300" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M17,8C8,10 5.9,16.17 3.82,21.34L5.71,22L6.66,19.7C7.14,19.87 7.64,20 8,20C19,20 22,3 22,3C21,5 14,5.25 9,6.25C4,7.25 2,11.5 2,13.5C2,15.5 3.75,17.25 3.75,17.25C7,8 17,8 17,8Z"/>
              </svg>
            </div>
            <div class="leading-tight">
              <p class="text-[10px] uppercase tracking-[0.25em] text-emerald-300/80 font-medium">Naturopathic Doctor</p>
              <p class="text-lg font-semibold text-white tracking-tight">Dr. Colin MacLeod <span class="text-emerald-300 font-normal">ND</span></p>
            </div>
          </a>

          <!-- Centered Navigation -->
          <div class="hidden lg:flex items-center justify-center flex-1 gap-8 text-sm font-medium text-white" role="navigation" aria-label="Main navigation">
            <a href="/" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname === '/' ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname === '/' ? 'page' : undefined}>Home</a>
            <a href="/about" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname.startsWith('/about') ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname.startsWith('/about') ? 'page' : undefined}>About</a>
            <a href="/services" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname.startsWith('/services') ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname.startsWith('/services') ? 'page' : undefined}>Services</a>
            <a href="/conditions" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname.startsWith('/conditions') ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname.startsWith('/conditions') ? 'page' : undefined}>Conditions</a>
            <a href="/contact" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname.startsWith('/contact') ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname.startsWith('/contact') ? 'page' : undefined}>Contact</a>
            <a href="/articles" class={`hover:text-emerald-200 transition-colors pb-1 border-b-2 ${Astro.url.pathname.startsWith('/articles') ? 'text-emerald-300 border-emerald-400' : 'border-transparent'}`} aria-current={Astro.url.pathname.startsWith('/articles') ? 'page' : undefined}>Articles</a>
          </div>

          <!-- Right Side: Search + Book Button + Mobile Menu -->
          <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
            <Search />
            <a
              href="https://macleodnaturopathic.janeapp.com/"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-3 sm:px-5 py-2 sm:py-2.5 rounded-full bg-emerald-400 text-emerald-950 font-semibold hover:bg-emerald-300 hover:-translate-y-0.5 transition-all duration-200 shadow-lg shadow-emerald-500/20 hover:shadow-emerald-400/30 text-sm sm:text-base whitespace-nowrap"
            >
              <span class="sm:hidden">Book</span>
              <span class="hidden sm:inline">Book Online</span>
              <Calendar class="hidden sm:block w-5 h-5" aria-hidden="true" />
            </a>
            <!-- Mobile Menu Button -->
            <button
              id="mobile-menu-button"
              class="lg:hidden p-3 text-white hover:text-white/80 transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
              aria-label="Toggle menu"
              aria-expanded="false"
            >
              <Menu id="menu-icon" class="w-6 h-6" aria-hidden="true" />
              <X id="close-icon" class="w-6 h-6 hidden" aria-hidden="true" />
            </button>
          </div>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="lg:hidden pb-6 overflow-hidden transition-all duration-300 ease-out max-h-0 opacity-0" role="navigation" aria-label="Mobile navigation">
          <div class="flex flex-col space-y-1 text-emerald-100 font-semibold">
            <a href="/" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname === '/' ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname === '/' ? 'page' : undefined}>Home</a>
            <a href="/about" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname.startsWith('/about') ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname.startsWith('/about') ? 'page' : undefined}>About</a>
            <a href="/services" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname.startsWith('/services') ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname.startsWith('/services') ? 'page' : undefined}>Services</a>
            <a href="/conditions" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname.startsWith('/conditions') ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname.startsWith('/conditions') ? 'page' : undefined}>Conditions</a>
            <a href="/contact" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname.startsWith('/contact') ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname.startsWith('/contact') ? 'page' : undefined}>Contact</a>
            <a href="/articles" class={`hover:text-white hover:bg-emerald-800/50 transition-colors py-4 px-3 text-2xl rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400 ${Astro.url.pathname.startsWith('/articles') ? 'text-white bg-emerald-800/30' : ''}`} aria-current={Astro.url.pathname.startsWith('/articles') ? 'page' : undefined}>Articles</a>
          </div>
        </div>
      </div>
    </header>

    <script>
      let menuListenerBound = false;

      function initMobileMenu() {
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');
        const closeIcon = document.getElementById('close-icon');

        // Close menu on page navigation (always runs)
        if (mobileMenu) {
          mobileMenu.style.maxHeight = '0';
          mobileMenu.style.opacity = '0';
        }
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        mobileMenuButton?.setAttribute('aria-expanded', 'false');

        // Only bind click listener once (header persists)
        if (menuListenerBound) return;
        menuListenerBound = true;

        mobileMenuButton?.addEventListener('click', () => {
          const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
          mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString());
          menuIcon?.classList.toggle('hidden');
          closeIcon?.classList.toggle('hidden');

          if (mobileMenu) {
            if (!isExpanded) {
              mobileMenu.style.maxHeight = mobileMenu.scrollHeight + 'px';
              mobileMenu.style.opacity = '1';
            } else {
              mobileMenu.style.maxHeight = '0';
              mobileMenu.style.opacity = '0';
            }
          }
        });
      }

      initMobileMenu();
      document.addEventListener('astro:page-load', initMobileMenu);
    </script>

    <!-- Main Content -->
    <main id="main-content" class="pt-24">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="reveal bg-emerald-50 border-t border-emerald-200/60 relative overflow-hidden">
      <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
        <div class="absolute -right-16 -top-16 w-64 h-64 rounded-full bg-emerald-200/30 blur-3xl"></div>
        <div class="absolute -left-10 bottom-0 w-52 h-52 rounded-full bg-emerald-900/10 blur-3xl"></div>
      </div>
      <div class="section-shell py-16 relative z-10">
        <div class="grid lg:grid-cols-2 gap-12 lg:gap-20">
          <!-- About -->
          <div class="space-y-3">
            <p class="pill">Evidence-Based + Natural</p>
            <h3 class="text-2xl font-semibold">Dr. Colin MacLeod ND</h3>
            <p class="text-slate-700 leading-relaxed">
              Halifax-based naturopathic doctor combining clinical nutrition, lifestyle modification, regenerative injections, IV nutrient therapy, herbal medicine and acupuncture for long-term health results.
            </p>
          </div>

          <!-- Contact + Services -->
          <div class="grid sm:grid-cols-2 gap-8">
            <div class="space-y-3">
              <p class="uppercase tracking-[0.2em] text-xs text-emerald-900 font-semibold">Contact</p>
              <div class="text-slate-800 space-y-2">
                <div class="space-y-0.5">
                  <p class="font-medium">Optimal Wellbeing Clinic</p>
                  <p>6140 Young Street</p>
                  <p>Halifax, NS B3K 0G2</p>
                </div>
                <a href="tel:+19024064424" class="flex items-center text-emerald-800 font-semibold hover:text-emerald-900">
                  (902) 406-4424
                </a>
                <a href="https://macleodnaturopathic.janeapp.com/" target="_blank" rel="noopener noreferrer" class="group flex items-center text-emerald-800 font-semibold hover:text-emerald-700 transition-colors">
                  Book Online
                  <ChevronRight class="w-5 h-5 ml-2 group-hover:translate-x-0.5 transition-transform" aria-hidden="true" />
                </a>
              </div>
            </div>

            <div class="space-y-3">
              <p class="uppercase tracking-[0.2em] text-xs text-emerald-900 font-semibold">Services</p>
              <div class="text-slate-800 space-y-2">
                <a href="/lab-testing" class="block hover:text-emerald-800 transition-colors">Private Blood Testing</a>
                <a href="/services" class="block hover:text-emerald-800 transition-colors">Clinical Nutrition</a>
                <a href="/iv-therapy" class="block hover:text-emerald-800 transition-colors">IV Therapy</a>
                <a href="/prolotherapy" class="block hover:text-emerald-800 transition-colors">Prolotherapy</a>
                <a href="/acupuncture" class="block hover:text-emerald-800 transition-colors">Acupuncture</a>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-8">
          <MedicalDisclaimer />
          <div class="mt-4">
            <p class="text-sm text-slate-600">&copy; {new Date().getFullYear()} Dr. Colin MacLeod ND. All rights reserved.</p>
          </div>
        </div>
      </div>
    </footer>


    <!-- Scroll-triggered reveal animations & header scroll effect -->
    <script>
      function initRevealObserver() {
        const reveals = document.querySelectorAll('.reveal:not(.visible)');
        if (!reveals.length) return;

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });

        reveals.forEach(el => observer.observe(el));
      }

      let scrollListenerBound = false;
      function initHeaderScroll() {
        if (scrollListenerBound) return;
        scrollListenerBound = true;

        const header = document.getElementById('site-header');
        if (!header) return;
        const headerEl = header;

        function onScroll() {
          if (window.scrollY > 20) {
            headerEl.classList.add('scrolled');
          } else {
            headerEl.classList.remove('scrolled');
          }
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
      }

      initRevealObserver();
      initHeaderScroll();
      document.addEventListener('astro:page-load', () => {
        initRevealObserver();
        initHeaderScroll();
      });
    </script>

  </body>
</html>
