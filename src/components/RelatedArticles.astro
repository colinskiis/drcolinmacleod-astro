---
// RelatedArticles.astro
// Displays related articles based on shared tags and categories
import { getCollection } from 'astro:content';

interface Props {
  currentSlug: string;
  currentTags: string[];
  currentCategories: string[];
  limit?: number;
}

const { currentSlug, currentTags, currentCategories, limit = 5 } = Astro.props;

// Get all published articles
const allArticles = await getCollection('articles', ({ data }) => !data.draft);

// Score articles by relevance (shared tags and categories)
const scoredArticles = allArticles
  .filter((article) => article.slug !== currentSlug)
  .map((article) => {
    let score = 0;

    // Score for shared categories (weighted higher)
    const sharedCategories = article.data.categories.filter((cat) =>
      currentCategories.includes(cat)
    );
    score += sharedCategories.length * 3;

    // Score for shared tags
    const sharedTags = article.data.tags?.filter((tag) =>
      currentTags?.includes(tag)
    ) || [];
    score += sharedTags.length * 2;

    return { article, score };
  })
  .filter(({ score }) => score > 0)
  .sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return new Date(b.article.data.publishDate).getTime() - new Date(a.article.data.publishDate).getTime();
  })
  .slice(0, limit)
  .map(({ article }) => article);

// If we don't have enough related articles, pad with recent ones
const recentArticles = scoredArticles.length < limit
  ? allArticles
      .filter((article) =>
        article.slug !== currentSlug &&
        !scoredArticles.some((ra) => ra.slug === article.slug)
      )
      .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
      .slice(0, limit - scoredArticles.length)
  : [];

const relatedArticles = [...scoredArticles, ...recentArticles];
---

{relatedArticles.length > 0 && (
  <div>
    <h3 class="text-2xl font-serif font-bold text-emerald-950 mb-4">Related Articles</h3>
    <div>
      {relatedArticles.map((article) => (
        <a
          href={`/articles/${article.slug}`}
          class="group flex items-center gap-4 py-4 border-b border-gray-100 last:border-0 hover:text-emerald-700 transition-colors"
        >
          <span class="flex-1 font-serif font-semibold text-gray-900 group-hover:text-emerald-700 transition-colors leading-snug">
            {article.data.title}
          </span>
          <svg class="w-4 h-4 text-gray-300 group-hover:text-emerald-600 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      ))}
    </div>
  </div>
)}
