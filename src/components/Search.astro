---
// Search component for site-wide search functionality
---

<div class="relative" id="search-container">
  <button
    id="search-toggle"
    class="p-3 rounded-full border border-white/25 text-white hover:bg-white/10 transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 focus:ring-offset-emerald-950"
    aria-label="Search (Press Ctrl+K)"
    title="Search (Ctrl+K)"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z"></path>
    </svg>
  </button>

  <!-- Search Overlay -->
  <div
    id="search-overlay"
    class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-label="Site search"
  >
    <div class="flex items-start justify-center min-h-screen pt-16">
      <div class="bg-white rounded-2xl shadow-2xl shadow-emerald-900/10 w-full max-w-2xl mx-4 border border-emerald-900/10">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold" id="search-title">Search Content</h3>
            <button
              id="search-close"
              class="text-gray-400 hover:text-emerald-700 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 min-w-[44px] min-h-[44px] flex items-center justify-center"
              aria-label="Close search"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <div class="relative mb-4">
            <input
              type="text"
              id="search-input"
              placeholder="Search articles, services, and conditions..."
              class="w-full px-4 py-3 pl-10 rounded-lg border border-emerald-900/20 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white"
              autocomplete="off"
              aria-describedby="search-help"
            >
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>

          <!-- Filter Buttons -->
          <div class="flex flex-wrap gap-2 mb-4" role="group" aria-label="Filter search results">
            <button class="search-filter active" data-type="all" aria-pressed="true">All</button>
            <button class="search-filter" data-type="articles" aria-pressed="false">Articles</button>
            <button class="search-filter" data-type="services" aria-pressed="false">Services</button>
            <button class="search-filter" data-type="conditions" aria-pressed="false">Conditions</button>
          </div>

          <!-- Search Results -->
          <div
            id="search-results"
            class="max-h-96 overflow-y-auto"
            role="region"
            aria-live="polite"
            aria-atomic="false"
          >
            <p id="search-help" class="text-gray-500 text-center py-8">
              Start typing to search articles, services, and conditions...
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-filter {
    @apply px-4 py-2 text-sm rounded-full border border-emerald-900/20 text-emerald-900 hover:bg-emerald-50 transition-colors min-h-[44px] focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2;
  }

  .search-filter.active {
    @apply bg-emerald-900 text-white border-emerald-900;
  }

  .search-result-link {
    @apply block p-3 border-b border-emerald-900/10 hover:bg-emerald-50/60 transition-colors focus:outline-none focus:bg-emerald-100 focus:ring-2 focus:ring-inset focus:ring-emerald-500;
  }

  .search-result-link:last-child {
    @apply border-b-0;
  }
</style>

<script>
  import Fuse from 'fuse.js';

  class SiteSearch {
    constructor() {
      this.fuse = null;
      this.searchData = [];
      this.currentFilter = 'all';
      this.selectedIndex = -1;
      this.resultLinks = [];
      this.init();
    }

    async init() {
      // Initialize search data
      await this.loadSearchData();

      // Set up event listeners
      this.setupEventListeners();
    }

    async loadSearchData() {
      try {
        // Load all search data from API
        const response = await fetch('/api/search-data.json');
        if (response.ok) {
          const data = await response.json();
          // Combine all data types into a single searchable array
          this.searchData = [
            ...(data.articles || []),
            ...(data.services || []),
            ...(data.conditions || [])
          ];
        } else {
          console.warn('Could not load search data from API');
          this.searchData = [];
        }

        // Initialize Fuse search
        const options = {
          keys: ['title', 'description', 'category'],
          threshold: 0.3,
          includeScore: true
        };

        this.fuse = new Fuse(this.searchData, options);
      } catch (error) {
        console.error('Error loading search data:', error);
        this.searchData = [];
      }
    }

    setupEventListeners() {
      const searchToggle = document.getElementById('search-toggle');
      const searchOverlay = document.getElementById('search-overlay');
      const searchClose = document.getElementById('search-close');
      const searchInput = document.getElementById('search-input');
      const filterButtons = document.querySelectorAll('.search-filter');

      // Open search
      const openSearch = () => {
        searchOverlay?.classList.remove('hidden');
        searchInput?.focus();
        document.body.style.overflow = 'hidden';
      };

      searchToggle?.addEventListener('click', openSearch);

      // Keyboard shortcut: Ctrl+K or Cmd+K
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          if (searchOverlay?.classList.contains('hidden')) {
            openSearch();
          } else {
            closeSearch();
          }
        }
      });

      // Close search
      const closeSearch = () => {
        searchOverlay?.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        this.clearResults();
        this.selectedIndex = -1;
        document.body.style.overflow = '';
      };

      searchClose?.addEventListener('click', closeSearch);

      // Close on overlay click
      searchOverlay?.addEventListener('click', (e) => {
        if (e.target === searchOverlay) {
          closeSearch();
        }
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !searchOverlay?.classList.contains('hidden')) {
          closeSearch();
        }
      });

      // Search input with keyboard navigation
      searchInput?.addEventListener('input', (e) => {
        this.selectedIndex = -1;
        this.performSearch((e.target as HTMLInputElement).value);
      });

      // Keyboard navigation for results
      searchInput?.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          this.navigateResults(1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          this.navigateResults(-1);
        } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
          e.preventDefault();
          this.resultLinks[this.selectedIndex]?.click();
        }
      });

      // Filter buttons
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          filterButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
          });
          button.classList.add('active');
          button.setAttribute('aria-pressed', 'true');
          this.currentFilter = (button as HTMLElement).dataset.type || 'all';
          this.performSearch(searchInput?.value || '');
        });
      });
    }

    navigateResults(direction: number) {
      this.resultLinks = Array.from(document.querySelectorAll('.search-result-link'));
      if (this.resultLinks.length === 0) return;

      // Remove highlight from current
      if (this.selectedIndex >= 0 && this.resultLinks[this.selectedIndex]) {
        this.resultLinks[this.selectedIndex].classList.remove('bg-emerald-100');
      }

      // Calculate new index
      this.selectedIndex += direction;
      if (this.selectedIndex < 0) this.selectedIndex = this.resultLinks.length - 1;
      if (this.selectedIndex >= this.resultLinks.length) this.selectedIndex = 0;

      // Highlight and scroll to new selection
      const selected = this.resultLinks[this.selectedIndex];
      if (selected) {
        selected.classList.add('bg-emerald-100');
        selected.scrollIntoView({ block: 'nearest' });
        selected.focus();
      }
    }

    performSearch(query: string) {
      const resultsContainer = document.getElementById('search-results');

      if (!query.trim()) {
        this.clearResults();
        return;
      }

      if (!this.fuse) {
        if (resultsContainer) {
          resultsContainer.innerHTML = '<p class="text-red-500 text-center py-4">Search not available</p>';
        }
        return;
      }

      let results = this.fuse.search(query);

      // Filter by type if needed
      if (this.currentFilter !== 'all') {
        results = results.filter(result => {
          if (this.currentFilter === 'articles') {
            return result.item.type === 'article';
          } else if (this.currentFilter === 'services') {
            return result.item.type === 'service';
          } else if (this.currentFilter === 'conditions') {
            return result.item.type === 'condition';
          }
          return true;
        });
      }

      this.displayResults(results, query);
    }

    displayResults(results: any[], query: string) {
      const resultsContainer = document.getElementById('search-results');
      if (!resultsContainer) return;

      if (results.length === 0) {
        resultsContainer.innerHTML = `
          <p class="text-gray-500 text-center py-8">
            No results found for "${this.escapeHtml(query)}"
          </p>
        `;
        return;
      }

      const resultsHTML = results.slice(0, 10).map((result, index) => {
        const item = result.item;
        const typeColor = {
          'article': 'text-emerald-700 bg-emerald-100',
          'service': 'text-blue-700 bg-blue-100',
          'condition': 'text-purple-700 bg-purple-100'
        }[item.type as string] || 'text-gray-700 bg-gray-100';

        return `
          <a href="${this.escapeHtml(item.url)}" class="search-result-link" tabindex="0">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xs px-2 py-1 rounded ${typeColor} font-medium">
                    ${this.escapeHtml(item.type.toUpperCase())}
                  </span>
                  ${item.category ? `<span class="text-xs text-gray-500">${this.escapeHtml(item.category)}</span>` : ''}
                </div>
                <h4 class="font-semibold text-gray-900 mb-1">${this.escapeHtml(item.title)}</h4>
                <p class="text-sm text-gray-600 line-clamp-2">${this.escapeHtml(item.description)}</p>
              </div>
              <svg class="w-4 h-4 text-gray-400 ml-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </a>
        `;
      }).join('');

      resultsContainer.innerHTML = `
        <p class="sr-only">${results.length} results found</p>
        ${resultsHTML}
      `;

      this.resultLinks = Array.from(document.querySelectorAll('.search-result-link'));
    }

    escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    clearResults() {
      const resultsContainer = document.getElementById('search-results');
      if (resultsContainer) {
        resultsContainer.innerHTML = `
          <p id="search-help" class="text-gray-500 text-center py-8">
            Start typing to search articles, services, and conditions...
          </p>
        `;
      }
      this.resultLinks = [];
    }
  }

  // Initialize search when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new SiteSearch();
  });
</script>
